{"name":"Room Status","type":"virtual_device","properties":{"deviceIcon":1008,"currentIcon":"1008","log":"","logTemp":"","mainLoop":"\nlocal MotionList = {649};\nlocal OffTimer = 60*60; -- unit is second\n\n\nlocal CurrentTime = os.time();\nlocal SelfId = fibaro:getSelfId();\nlocal TimeFormat = \"%H:%M:%S\";\nfibaro:call(SelfId, \"setProperty\", \"ui.lblCurrentTime.value\", os.date(TimeFormat, CurrentTime));\n\n-- Check Motion Status (MotionList)\nfor MotionCount = 1, #MotionList do\n  local CurrentMotionStatus = fibaro:getValue(MotionList[MotionCount], \"value\");\n  local CurrentMotionName = fibaro:getName(MotionList[MotionCount]);\n  \n  fibaro:debug(\"Motion ID : \" .. MotionList[MotionCount]);\n  fibaro:debug(\"Motion Status : \" .. CurrentMotionStatus);\n  fibaro:debug(\"Motion Name : \" .. CurrentMotionName);\n  \n  if(CurrentMotionStatus == \"1\") then\n    LastBreachTime = CurrentTime;\n    fibaro:debug(\"Set Last Breach to \" .. LastBreachTime);\n    fibaro:call(SelfId, \"setProperty\", \"ui.lblLastPIR.value\", CurrentMotionName);\n    break;\n  end\nend\n\n\n--LastBreachTime = fibaro:getValue(SelfId, \"ui.lblLastBreach.value\");\n--fibaro:debug(\"LastBreachTime = \" .. LastBreachTime);\n\n-- ถ้า LastBreachTime เป็น null ให้จับเท่ากับ CurrentTime\nif(LastBreachTime == nil) then \n  LastBreachTime = CurrentTime;\nend\n  \nfibaro:call(SelfId, \"setProperty\", \"ui.lblLastBreach.value\", os.date(TimeFormat, LastBreachTime));\nfibaro:debug(\"LastBreachTime = \" .. LastBreachTime);\n\nlocal Diff = tonumber(CurrentTime) - tonumber(LastBreachTime);\nlocal TimeLeft = OffTimer - Diff;\nif(TimeLeft < 0) then TimeLeft = 0; end\nfibaro:call(SelfId, \"setProperty\", \"ui.lblTimeLeft.value\", TimeLeft .. \" s\");\n\nfibaro:debug(\"Diff Time : \" .. Diff);\nif(Diff >= OffTimer) then \n  fibaro:call(SelfId, \"setProperty\", \"ui.lblRoomStatus.value\", \"Unoccupied\");\n  fibaro:setGlobal(\"Occupation\",\"Unoccupied\");\n  --if(fibaro:getValue(19, \"value\") == \"1\") then fibaro:call(19, \"turnOff\"); end\n  \nelse\n  fibaro:call(SelfId, \"setProperty\", \"ui.lblRoomStatus.value\", \"Occupied\");\n  fibaro:setGlobal(\"Occupation\",\"Occupied\");\n  --if(fibaro:getValue(19, \"value\") == \"0\") then fibaro:call(19, \"turnOn\"); end\nend\n\n\n\n","ui.lblCurrentTime.value":"16:34:34","ui.lblLastBreach.value":"16:34:12","ui.lblLastPIR.value":"648","ui.lblRoomStatus.value":"Occupied","ui.lblTimeLeft.value":"3578 s","visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"Current Time","name":"lblCurrentTime","favourite":false,"main":false}]},{"type":"label","elements":[{"id":2,"lua":false,"waitForResponse":false,"caption":"Last Breach","name":"lblLastBreach","favourite":false,"main":false}]},{"type":"label","elements":[{"id":3,"lua":false,"waitForResponse":false,"caption":"Room Status","name":"lblRoomStatus","favourite":false,"main":true}]},{"type":"label","elements":[{"id":4,"lua":false,"waitForResponse":false,"caption":"Time Left","name":"lblTimeLeft","favourite":false,"main":false}]},{"type":"label","elements":[{"id":5,"lua":false,"waitForResponse":false,"caption":"Last PIR","name":"lblLastPIR","favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}